---
title: "Reporte de analisis Abejas polinizadoras"
author: "Cesar PeÃ±aranda"
output:
  html_document: default
  pdf_document: default
date: "2023-10-15"
---

Codigos de mes

-   noviembre 2018 = 1

-   marzo 2019 = 2

-   abril 2019 = 3

-   octubre 2019 = 4

-   noviembre 2019 = 5

-   marzo 2020 = 6

Codigos de especie

-   "Apis_mellifera" = "apis"

-   "Euglossa_viridissima" = "euglo"

-   "Polybia_occidentalis" = "poly"

-   "Toxomerus_2" = "toxo"

-   "Trigona_corvina" = "trigo"

Carga de la base

```{r}
load("bases/base_abejas.Rdata")
levels(base_abejas$especie)=c("apis","euglo","poly","toxo","trigo")
```

### **Histogramas de distribucion**

```{r}
par(mfrow=c(1,5))
hist(base_abejas$conteo[base_abejas$especie=="apis"], main = "Para apis",xlab = "conteo")
hist(base_abejas$conteo[base_abejas$especie=="euglo"],main = "Para euglo",xlab = "conteo")
hist(base_abejas$conteo[base_abejas$especie=="poly"], main = "Para poly",xlab = "conteo")
hist(base_abejas$conteo[base_abejas$especie=="toxo"], main = "Para toxo",xlab = "conteo")
hist(base_abejas$conteo[base_abejas$especie=="trigo"],main = "Para trigo",xlab = "conteo")
```

### **Analizando si se cumple el supuesto de poiss (var=media) en la especie**

```{r}
media=tapply(base_abejas$conteo,base_abejas$especie,mean)
var=tapply(base_abejas$conteo,base_abejas$especie,var)
round(cbind(media,var),3)
```

### **Grafico boxplot por conteo/especie**

```{r}
boxplot(conteo~especie,data = base_abejas,cex.axis = 0.6)
abline(h=mean(base_abejas$conteo),col="red")
points(media, col="blue", pch=16)
```

### **Analizis del supuesto poiss para zona**

```{r}
media=tapply(base_abejas$conteo,base_abejas$zona,mean)
var=tapply(base_abejas$conteo,base_abejas$zona,var)
round(cbind(media,var),3)
```

### **Grafico boxplot por conteo/zona**

```{r}
boxplot(conteo~zona,data = base_abejas,cex.axis = 0.6)
abline(h=mean(base_abejas$conteo),col="red")
points(media, col="blue", pch=16)
```

### **Analizis del supuesto poiss para mes**

```{r}
media=tapply(base_abejas$conteo,base_abejas$mes,mean)
var=tapply(base_abejas$conteo,base_abejas$mes,var)
round(cbind(media,var),3)
```

### **Grafico boxplot por conteo/mes**

```{r}
media=tapply(base_abejas$conteo,base_abejas$mes,mean)
boxplot(conteo~mes,data = base_abejas,cex.axis = 0.6)
abline(h=mean(base_abejas$conteo),col="red")
points(media, col="blue", pch=16)
```

### **Supuesto poiss para especie\|zona**

```{r}
media2=tapply(base_abejas$conteo,list(base_abejas$especie,base_abejas$zona),mean)
var2=tapply(base_abejas$conteo,list(base_abejas$especie,base_abejas$zona),var)
round(cbind(media2,var2),3)
```

### **Analisis tipo box para ver el comportamiento zona\|especie**

```{r}
library(lattice)
dotplot(conteo~especie|zona,xlab="especie",ylab="conteo",data = base_abejas)
```

### **Analisar diferencias segun el mes**

```{r}
dotplot(conteo~especie|mes,xlab="especie",ylab="conteo",data = base_abejas)
```

### **Analizando graficamente interacion zona\|especie**

```{r}
xyplot(conteo~especie,group=zona,type="a",data=base_abejas,auto.key=list(columns=4))
```

***Se logra ver interacion***

### **Analizando graficamente interacion mes\|especie**

```{r}
xyplot(conteo~especie,group=mes,type="a",data=base_abejas,auto.key=list(columns=4))
```

***Igualmente se observa interacion***

### **Modelo inicial**

```{r}
mod0=glm(conteo~especie*zona+mes,family = poisson,data = base_abejas)

library(AER)
#quasi-Poisson
dispersiontest(mod0,trafo = 1)

#binomial negativa
dispersiontest(mod0,trafo = 2)
```

**Gracias a los resultados de las pruebas trafo se decide utilizar un modelo quasipoisson**

### **Modelo mas optimo 1 asumiendo interaccion entre mes y especie (anteriormente se probo que no hay interaccion triple) no queda claro si es lo adecuado ya que el mes podria ser visto como bloque**

```{r}
mod1=glm(conteo~especie+zona+mes+especie+especie*zona+especie*mes,family =quasipoisson,data = base_abejas)
summary(mod1)$disp
```

### **Prueba formal de interaccion mes\|especie**

```{r}
drop1(mod1,test = "F")
```

***Efectivamente encontramos interaccion entre especie y mes***

### **Modelo mas optimo 2 no asumiendo interaccion entre mes y especie (unicamente entre zona y especie)**

```{r}
mod1=glm(conteo~especie*zona+mes,family =quasipoisson,data = base_abejas)
summary(mod1)$disp
```

### **Prueba formal de interaccion zona\|especie**

```{r}
drop1(mod1,test = "F")
```

***efectivamente hay interacion entre zona y especie por lo que las comparaciones son por especie segun zona***

### **Comparaciones**

```{r}
contrasts(base_abejas$especie)
contrasts(base_abejas$zona)
```

```{r}
coef=mod1$coefficients
```

```{r}
summary(mod1)
```

### **Se haran solo para finca garzas hasta confirmar que el analisis es el adecuado**

```{r}
#Para finca garzas
apis= c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)  
euglo=c(1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)    
poly= c(1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0) 
toxo= c(1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)   
trigo=c(1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)    

vec=cbind(apis,euglo,poly,toxo,trigo)
eta=t(vec)%*%coef
exp(eta)

#contrastes
ap_eu=apis-euglo
ap_po=apis-poly
ap_to=apis-toxo
ap_tr=apis-trigo
eu_po=euglo-poly
eu_to=euglo-toxo
eu_tr=euglo-trigo
po_to=poly-toxo
po_tr=poly-trigo
to_tr=toxo-trigo

h=cbind(ap_eu,ap_po,ap_to,ap_tr,eu_po,eu_to,eu_tr,po_to,po_tr,to_tr)
L=t(h)%*%coef

#error
ee=sqrt(diag(t(h)%*%vcov(mod1)%*%h))

#valor estandarizado
qt=L/ee
#prueba
k=10
gl=nrow(base_abejas)-length(coef)
p=pt(qt,gl,lower.tail = F);p
p>0.05/k
```

***Para finca garzas se econtraron diferencias significativas entre Apis mellifera y Euglossa viridissima al igual que entre Apis mellifera y Toxomerus***
