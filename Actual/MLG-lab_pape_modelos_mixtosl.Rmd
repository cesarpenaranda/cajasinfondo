---
title: "Untitled"
output: html_document
date: "2023-10-16"
---

PARCELAS DIVIDIDAS

Papel 1
Un fabricante de papel está interesado en tres métodos para preparar la pulpa y cuatro temperaturas de cocción de la pulpa. Aunque la temperatura es una variable continua, solo se van a estudiar 4 temperaturas,por lo que se toma como un factor fijo.
El fabricante desea estudiar el efecto del método y de la temperatura sobre la resistencia a la tensión del papel,que es el esfuerzo máximo a tensión obtenido durante una prueba hasta la ruptura bajo unas condiciones prescritas. El esfuerzo es expresado como la fuerza por unidad del ancho de la muestra puesta a prueba,medido en kg/cm. Cada réplica de un factorial requiere 12 observaciones y el investigador ha decidido correr tres réplicas. El
experimento se lleva a cabo de la siguiente forma:

• Produce 3 lotes de pulpa con cada uno de los 3 métodos que está estudiando en un orden aleatorio. En total produce 9 lotes de pulpa.
• Cada vez que produce un lote lo divide en cuatro partes o muestras y realiza la cocción de cada muestra con una temperatura diferente asignada aleatoriamente.

# Plante
* Factores:
- temperatura 4 (fijas)
- metodos de preparacion 3 (fijos)
* bloque
- lote total 9 (3 lotes por metodo)
cada lote se divide en 4 para aplicarle cada temperatura

Ejercicios
1. Utilice los datos que se encuentran en el archivo papel.Rdata. Asegúrese que están bien definidos los factores método y temperatura.
```{r}
load("Bases/papel.Rdata")
str(base)
base$metodo=as.factor(base$metodo)
levels(base$metodo)=c("M1","M2","M3")
base$temp=as.factor(base$temp)
```

• La variable lote indica los lotes de pulpa, y se enumeran de 1 a 9 para diferenciar todos los lotes. Ponga juntas las variables metodo y lote para observar la correspondencia de los lotes con los métodos.
```{r}
base$metlot= paste(base$metodo, base$lote, sep = "-")
```

```{r}
base[,c(2,4)]
```

la correspondecia es la siguiente (4 replicas cada uno):

M1-1
M2-2
M2-3
M1-4
M3-5
M1-6
M3-7
M2-8
M3-9


• Haga una representación gráfica de los datos para ver el comportamiento de la respuesta según método y temperatura. Analice primero la interacción entre método y temperatura. Use type="a" en la función xyplot. En los diseños de parcela divididas se pone más énfasis al factor que está en la subparcela, por lo que ese factor debe colocarse en groups, mientras que el factor de parcela se coloca en el eje X.
```{r}
library(lattice)
xyplot(res~metodo,group=temp,type="a",data=base,auto.key=list(columns=4))
```

• Basado en lo que ve en el gráfico, se espararía un efecto de la temperatura?

es correcto se observa un posible efecto de la temperatura en la resistencia a la tencion

• ¿Qué implicaciones tendría una interacción entre método y temperatura?

implica que no se pueden dar concluiones independientes de ninguno de los dos factores por lo que se debe tener encuentra el metodo en conjunto con la temperatura a la hora de dar las conclusiones

2. Haga el análisis usando la función lmer de la librería lme4. La parte aleatoria son los bloques que se separan con un + del resto del modelo y se pone entre paréntesis (1|bloque). La instrucción completa debe quedar de la siguiente forma: lmer(Y~FP*FSP+(1|bloque)).

```{r}
library(lme4)
```

```{r}
mod1=lmer(res~metodo*temp+(1|lote),data = base)
```

• El anova que da esta librería no tiene las probabilidades asociadas, pero se pueden calcular con los valores de F que da el anova, siempre que se sepa cómo calcular los grados de libertad. Los grados de libertad para el error de parcela se obtienen sabiendo que los lotes están anidados dentro de cada método. Entonces se tienen a(r-1) grados de libertad, donde a es el número de métodos y r el número de lotes por cada método. En este caso 3*(3-1)=6. El error de subparcela se calcula con n-p-gl.parcela, donde p es el número de coeficientes (1 de intercepto, 2 de métodos, 3 de temperaturas, 6 de interacción, son 12 coeficientes), por lo que el error de parcela tiene 36-12-6=18 grados de libertad. La probabilidad para la interacción se calcula con el error de subparcela.
```{r}
a=3
r=3
gl=a*(r-1)
n=nrow(base)
p=nrow(summary(mod1)$coef)
err=n-p-gl
```

```{r}
anova(mod1)
```

```{r}
1-pf(2.2967,6,18)
```

• La función lme de la librería nlme permite hacer el análisis completo. Debe colocar dos fórmulas, en la primera se coloca del modo usual una fórmula con los factores fijos que en este caso son metodo y temp. El primero es el factor de parcela (FP) y el segundo el factor de subparcela (FSP). Aquí se puede incluir la interacción entre ambos. Luego se coloca en la parte aleatoria las subparcelas identificadas por lote separado por coma del resto del modelo, de la siguiente forma random=~1|lote. La instrucción completa debe quedar de la siguiente forma: lme(res~metodo*temp,random=~1|lote). En esta función debe usarse una variable de subparcela que identifique a cada lote con números únicos. Haga primero la prueba correspondiente a la interacción con anova(mod).
```{r}
library(nlme)
```

```{r}
mod2=lme(res~metodo*temp,random=~1|lote,data = base)
anova(mod2)
```

3. Asumiendo que no hay interacción entre metodo y temp, se pueden probar dos hipótesis, una sobre el efecto del método usando los grados de libertad de parcela y otra sobre el efecto de la temperatura usando los grados de libertad de subparcela.

• Use un modelo sin interacción y haga la prueba sobre el efecto de la temperatura comparando los promedios de forma marginal. Debe ajustar los grados de libertad, pues ahora los 6 grados de libertad de la interacción se suman al error de subparcela. De esta forma quedan 24 grados de libertad en la
subparcela.
```{r}
mod3=lme(res~metodo+temp,random=~1|lote,data = base)
anova(mod3)

mod3.1=lmer(res~metodo+temp+(1|lote),data = base)
anova(mod3.1)
1-pf(24.6241,3,24)
```

• Haga la prueba sobre el efecto del método. Use los grados de libertad de parcela que son 6. Estos grados de libertad no cambian haya o no interacción.
```{r}
mod3=lme(res~metodo+temp,random=~1|lote,data = base)
anova(mod3)

mod3.1=lmer(res~metodo+temp+(1|lote),data = base)
anova(mod3.1)
1-pf(3.9724,2,6)
```


4. Puesto que se supone que no hay interacción entre método y temperatura, para hacer comparaciones múltiples entre los promedios de las 4 temperaturas, se pueden hacer comparaciones de Tukey.
• Compare los promedios y obtenga límites inferiores para los casos en que tenga sentido. Se usan solo los coeficientes fijos, los cuales se extraen mediante summary(mod)$coef. Se pueden usar solo los coeficientes de temperatura, lo que es equivalente a poner los de método en cero, es decir, para hacer las comparaciones marginales. Debe usar los grados de libertad de supbparcela que son 24.
```{r}
coef=summary(mod3.1)$coef[,1]
model.matrix(mod3.1)
```
```{r}
#vectores individuales
t200=c(1,0,0,0,0,0)
t225=c(1,0,0,1,0,0)
t250=c(1,0,0,0,1,0)
t275=c(1,0,0,0,0,1)

vec=cbind(t200,t225,t250,t275)
eta=t(vec)%*%coef;eta
```
```{r}
#contrastes
t200_t225=t225-t200
t200_t250=t250-t200
t200_t275=t275-t200
t225_t250=t250-t225
t225_t275=t275-t225
t250_t275=t275-t250

h=cbind(t200_t225,t200_t250,t200_t275,t225_t250,t225_t275,t250_t275)
L=t(h)%*%coef

#error
vcov=vcov(mod3.1)[4:6,4:6]
ee=sqrt(diag(t(h)%*%vcov%*%h))
```

• Se pueden obtener las probabilidades de las comparaciones de Tukey usando la función lsmeans de la librería lsmeans con la siguiente instrucción lsmeans(mod2, pairwise~"temp", adjust="tukey"). Note que esto solo es útil para obtener las probabilidades pero no los intervalos o límites de confianza.
5. La nueva versión de lme4 tiene la función drop1 que debe usarse con test="Chisq" para hacer la prueba de razón de verosimilitud (LRT). Haga nuevamente la prueba de la hipótesis sobre la interacción sobre el modelo obtenido con lme4.