---
output:
  word_document: default
  html_document: default
---
```{r include=FALSE}
library(lattice)
library(ggplot2)
library(dplyr)
library(car)

```

# Potencia 
potencia(1-B)
probabilidad de encontrar diferencias de almenos delta (diferencia relevante), si en realidad existen 

* n es igual a numero de replicas por tratamiento
* grops es el numero de tratamientos
* library(pwr)

**Ejemplo tortugas**

factor dieta diseño (dieta,alimento)
factor sexo (macho,hembra)

son 8 tortugas por cada condicion 
```{r}
power.anova.test(groups = 2,n=8,between.var = var(c(30,32)),within.var=6.97101)
```
son dos grupos por que lo importante para mi era la condicion, por esto son solo dos grupos porque ignoramos el sexo

**conclusion**

Hay una probabilidad de 0,29 de llegar a la conclusión de que hay diferencias
cuando en realidad las medias difieren al menos 2 gr/dl. Es un experimento
que difícilmente va a lograr detectar que hay un efecto real de la condición de
alimento aún cuando sí se esté dando ese efecto.

**tamaño de muestra** 
```{r}
power.anova.test(groups=2,between.var=var(c(30,32)),within.var=6.97101,power=0.9)
```
Se necesitan 38 tortugas por condición para asegurar esa potencia

**Ejemplo tortugas con interaccion**

factor de diseño cond (estricta,balace, abun)
factor especie (chelos,kynos)
Se cuenta con 4 réplicas por condición de alimento dentro de cada especie.

estamos fijando la especia por eso son tres grupo, esto por la interaccion (especie,cond), lo podemos ver como cuando comparamos con bonferroni
```{r}
power.anova.test(groups = 3,n=4,between.var = var(c(30,31,32)),within.var=2.555556)
```

var(c(30,31,32)) el rango de las medias debe de ser igual a delta(diferencia relevante), exactamente el menor y el mayor, la resta de estos dos debe de darme mi diferencia relevante

**tamaño de muestra** 
```{r}
power.anova.test(groups = 3,power=0.9,between.var = var(c(30,31,32)),within.var=2.555556)
```
Con 18 datos por tratamiento

# nivel de picante 

factor de diseño -> nivel de picante 

* suave
* medio 
* fuerte 

factor incluido -> tipo de tomate 

* cherry
* pera

cantidad de catadores -> 8 jueces 

* cada uno prueba los 6 tratamientos

variable respuesta -> indice de satisfaccion 




a) realice los calculos necesarios para determinar que tanta potencia tiene este experimentos
con interacion

**con interacion**
```{r}
cmres=0.4970
power.anova.test(groups = 3,n=8,between.var = var(c(3.5,4,3.7)),within.var=cmres) 
```
no importa el orden en betwen el rango debe de ser la diferencia

**sin interacion**

no me importa el otro factor porque solo nos importa el nivel de picante, n pasa a ser el total de la fila picante
```{r}
cmres=0.4932
power.anova.test(groups = 3,n=16,between.var = var(c(3.5,4,3.7)),within.var=cmres)
```
trats es igual a 3 porque solo me importa el nivel de picante ademas hay 16 reps en total por cada picante 

b) explique claramente el significado del resultado del punto anterior

por las similutudes entre los cmres se puede esperar que no haya interaccion
se tiene una probabilidad de 0.40, de detectar diferencias de 0.5, si estas diferencias existen. 

c) realice los calculos adecuados para determinar el numero de personas que recomienda participen en el estudio para que se asegure una potencia minima de 0.90

**con interacion**
```{r}
cmres=0.4932
power.anova.test(groups = 3,power=0.90,between.var = var(c(3.5,4,3.7)),within.var=0.4932)
```
son 25 personas porque 50 es para cada uno de los niveles, pero cada nivel tiene dos grupos entonces son 25 por trat 
se necesita un n de 50

**sin interaccion**
```{r}
power.anova.test(groups=6,power=0.90,between.var=var(c(3.5,3.7,4)),within.var=0.4932)
```
serian 26 replicas por tratamiento 

d) explique claramente el significado del resultado del punto anterior 

esto quiere decir(punto con interaccion) que necesitamos 25 replicas por tratamientos para obtener una prob de .90 de encontrar diferencias entre los trats de 0.5 si estas realmente existen

#pregunta tipo de disolucion
2. Se realizó un experimento para encontrar el punto de equilibrio para la extracción de los pigmentos del azul de mata. El punto de equilibrio se alcanza cuando la concentración de pigmento extraído no tiene un cambio significativo con respecto a la cantidad de tiempo adicional que se expone la solución al calor.
Interesa analizar el efecto que tiene el tipo de disolución (agua con jabón y alcohol para fricciones 70%) sobre la concentración promedio de pigmento (moles/litro) extraído y se incluyen 5 tiempos de exposición (5, 10, 15, 20 y 25 minutos) y 3 masas (0.125, 0.25 y 0.5 gramos). Se considera el tiempo expuesto a una temperatura constante de 70 grados centígrados.
Para cada masa se seleccionan 30 muestras de plantas que se subdividen en dos conjuntos de 15 plantas; cada grupo se expone a una disolución (agua con jabón o alcohol). Posteriormente, cada conjunto se subdivide aleatoriamente en subgrupos de 3 plantas que serán asignados a los tiempos de exposición establecidos. Se pesa cada planta antes de exponerlas a la disolución.

use los datos de baseazul dentro del archivo datos5.Rdata

*factor de diseño -> tipo de disolucion
-agua con jabon
-alcohol para fricciones 

*respuesta -> concentracion pormedio de pigmento
-se mide en moles/litro

*factor-> tiempo de exposicion(minutos)
-5
-10
-15
-20
-25

*factor -> masas(gramos)
-0.125
-0.25 
-0.5 

cantidad de replicas -> 30 para cada masa 

esto se repite para cada una de las masas(0.125 , 0.25 , 0.5)

*15(agua con jabon)-disolucion
-3(5)
-3(10)
-3(15)
-3(20)
-3(25)

*15(alcohol)-disolucion
-3(5)
-3(10)
-3(15)
-3(20)
-3(25)

cov -> peso de la planta

diff relevante -> 2 moles/litro

a) Realice los cálculos adecuados para determinar la potencia que tiene este
experimento si se considera que dos medias son diferentes si distan al menos en 2 moles/litro. Considere el modelo adecuado con los 3 factores, pero no use la covariable. (10 puntos)

*crecion del modelo*
```{r include=FALSE}
load("Bases/datos5.Rdata")
head(baseazul)
str(baseazul)
mod1=lm(concentracion~disolvente+masa+tiempo+disolvente*masa+masa*tiempo,data = baseazul);anova(mod1)
drop1(mod1,test = "F")
```
**hay interaccion**

* con interacion
var es igual a c(4,6) porque tenemos dos grupos
```{r}
cmres=5.89 #el valor visto en clase
power.anova.test(groups = 2,n=15,between.var = var(c(4,6)),within.var=cmres)
```

b) ¿Cuántas plantas se necesitan para asegurar una potencia de 0.90 de detectar diferencias de 2 moles/litro? (4 puntos)
```{r}
cmres=5.89 #valor de ejemplo en clase
power.anova.test(groups = 2,power=0.90,between.var = var(c(4,6)),within.var=cmres)
```
se nesesitan 32 plantas por tratamiento es decir 32*6= 192 en total 

c) Basado en el modelo que escogió en el punto anterior, justifique si al incluir la covariable hay una reducción importante en la variabilidad que lleve a aumentar la potencia. Diga en cuánto se reduce la variabilidad y por qué considera que esa cantidad es mucha o poca (5 puntos), y compruebe si la potencia aumenta (4 puntos). (5+4=9 puntos)
```{r}
mod1=lm(concentracion~disolvente+masa+tiempo+disolvente*masa+masa*tiempo,data = baseazul)
#drop1(mod1,test = "F")
anova(mod1)
mod2=lm(concentracion~disolvente+masa+tiempo+peso+disolvente*masa+masa*tiempo,data = baseazul)
#drop1(mod2,test="F")
anova(mod2)
anova(mod1,mod2)

#cuanto se reduce 
anova(mod1)[6,2]
anova(mod2)[7,2]

#la SCRes pasa de 351.8928 al no incluir la cov a 258.2245 en el caso que si se incluye la cov esto es una reduccion en tomar encuenta de  93.6683, efectivamente reduce la variabilidad el incluir la cov 

power.anova.test(groups = 2,n = 15 ,between.var = var(c(4,6)),within.var = 3.64)
```
# Teoricas 1 
a) un experimentos tiene una potencia de 0.3 de detectar diferencias de 2 unidades, ¿ es posible que se llegue a la 
conclusion de que el factor de diseño si tenga un efecto sobre la respuesta promedio? justifique porque se puede dar esto. 
Si, es posible llegar a la conclusion de que el factor de diseño tenga un efecto sobre la respuesta promedio, esto porque aunque la probabilidad es baja, sigue siendo probable el encontrar diferencias de 2 unidades en el caso de que realmente existen

b) suponga que se tiene un experimento con una potencia de 0.9 cuando la diferencia relevante es de 5 unidades, altener 3 niveles del factor de diseño con 10 replicas y con una cierta varianza condicional

* Que sucede con la potencia en un experimento similar en el que se pierden 5 replicas en uno de los tratamientos? justifique

Es de esperar que la potencia disminuya, ya que como supuesto por lo general a mayor replicas mayor sera la potencia, si disminuimos las replicas esto va afecta la potencia en un sentido negativo**

* que sucede con la potencia en un experimento similar donde la vrinaza condicional es mayor? 

Si la varianza condicional es mayor, esperamos que la potencia disminuya esto porque a mayor varianza es mas dificil captar diferencias en casos en los que efectivamente existen

* Que se puede esperar de los promedios verdaderos si no se rechaza la hipotesis nula?
esperamos que los promedios sean iguales.

3.	Para medir el *efecto del detergente sobre el pH del agua* se realizó un diseño factorial. La variable respuesta fue la diferencia en valor absoluto entre el pH del agua antes de aplicarle cualquier detergente y el pH luego de haber aplicado el detergente. Esto debido a que un cambio en la acidez o pH del agua después de haber aplicado el detergente puede considerarse una medida de contaminación. Se considera que una *diferencia de 0.3* unidades entre los cambios de acidez o pH promedio de dos detergentes ya indican que uno de los detergentes es más contaminante que el otro.

Los *tipos de detergente* utilizados fueron los siguientes: *biodegradable marca Bluetech, ecológico marca Meyer y no biodegradable doméstico en barra marca San Luis*. Los investigadores pensaban que sus resultados podrían variar si se utilizaban distintos tiempos de exposición del agua al detergente, sin embargo, no podrían controlar este tiempo de exposición, sino que registraban el tiempo que el asistente les decía que había transcurrido desde que se aplicó el detergente a la muestra hasta que fue analizada.

La unidad experimental fue una muestra de 40 ml de agua recolectada. Se recolectaron *12 muestras* de 40 ml de manera individual en la Zona Protectora Río Tiribí, en San Ramón de La Unión. El instrumento de medición empleado fue el pH-metro, el cual regresa valores entre 0 y 14.

El *objetivo es investigar si hay diferencias relevantes entre los tipos de detergente*, cuál de ellos produce menor contaminación y cuantificar esas diferencias con 95% de confianza.  Para esto se usa un modelo que también tome en cuenta el tiempo de exposición y la interacción entre el factor de diseño y la covariable.

Los datos del experimento se encuentran en la base llamada “basedet1” dentro de ”datos5.Rdata”
```{r include=FALSE}
load("Bases/datos5.Rdata")
str(basedet1)
basedet1$det=as.factor(basedet1$det)
```

a)	Escriba la ecuación del modelo asociado al experimento en la forma larga (con variables auxiliares) y usando la restricción de tratamiento de referencia.  Diga cuál es esta restricción. (5 puntos)

b)	Justifique gráficamente si la inclusión de la covariable tiene algún beneficio en el análisis (5 puntos).
library(lattice)
```{r}
mod1=lm(ph~det,data=basedet1);anova(mod1)
mod2=lm(ph~det*tiempo,data =basedet1);anova(mod2)
boxplot(ph~det,data = basedet1)
xyplot(ph~tiempo|det,type=c("r","p"),data=basedet1)
```

c)	Justifique gráficamente si se espera interacción entre la covariable y el factor de diseño. (5 puntos)
```{r}
xyplot(ph~tiempo,groups=det,type=c("r","p"),data = basedet1)
```

d)	Realice el análisis adecuado para responder al objetivo planteado.  (15 puntos)
```{r}
mod2$coefficients
tapply(basedet1$ph,basedet1$det,mean)
summary(basedet1$tiempo)

x1=3
x2=45
x3=85
```
Por la interacion entre la cov y el factor, debemos hacerlo condicionalmente
```{r}
x=3
v1=c(1,0,0,x,0,0)
v2=c(1,1,0,x,x,0)
v3=c(1,0,1,x,0,x)

c1=v2-v1
c2=v3-v1
c3=v3-v2

cont=cbind(c1,c2,c3)

L=t(cont)%*%mod2$coefficients;L

#error 
ee=sqrt(diag(t(cont)%*%vcov(mod2)%*%cont))

#tprueba 
t=L/ee

#prueba
gl=nrow(basedet1)-length(mod2$coefficients)

p=pt(t,gl,lower.tail = F)
p>0.05/3
```

```{r}
x=45
v1=c(1,0,0,x,0,0)
v2=c(1,1,0,x,x,0)
v3=c(1,0,1,x,0,x)

c1=v2-v1
c2=v3-v1
c3=v3-v2

cont=cbind(c1,c2,c3)

L=t(cont)%*%mod2$coefficients;L

#error 
ee=sqrt(diag(t(cont)%*%vcov(mod2)%*%cont))

#tprueba 
t=L/ee

#prueba
gl=nrow(basedet1)-length(mod2$coefficients)

p=pt(t,gl,lower.tail = F)
p>0.05/3

#cotas 
qt=qt(1-0.05/3,gl)
lim=L[1:3]-qt*ee[1:3];lim
```
**solo v3-v1 es una diferencia significativa relevante**

```{r}
x=85
v1=c(1,0,0,x,0,0)
v2=c(1,1,0,x,x,0)
v3=c(1,0,1,x,0,x)

c1=v2-v1
c2=v3-v1
c3=v3-v2

cont=cbind(c1,c2,c3)

L=t(cont)%*%mod2$coefficients;L

#error 
ee=sqrt(diag(t(cont)%*%vcov(mod2)%*%cont))

#tprueba 
t=L/ee

#prueba
gl=nrow(basedet1)-length(mod2$coefficients)

p=pt(t,gl,lower.tail = F)
p>0.05/3

#cotas 
qt=qt(1-0.05/3,gl)
lim=L[1:3]-qt*ee[1:3];lim
```


**en el caso de x=85 todas las diferencias son significativas y relevantes**

## 6.2 Carrera 100 metros
Se hizo un estudio para examinar el efecto que tiene la posición de salida y el tipo
de calentamiento en el tiempo de recorrido de 100 metros planos. Se trabajó con la
población entre 17 a 24 años en la sede Rodrigo Facio de la Universidad Costa Rica.
Se usaron tres tipos de calentamiento: (A) solo estirando, (B) calentamiento normal
para hacer ejercicio regular y (C) calentamiento para correr. Además se usaron dos
tipos de salida: (+) salida baja con 4 apoyos y (-) salida normal de pie.
Para tomar en cuenta la variabilidad que introduce el hecho de que hay unos
estudiantes más grandes que otros y que además tienen pesos diferentes, se tomó
el peso y la estatura para calcular el índice de masa corporal de cada uno de ellos,
el cual se calcula dividiendo el peso entre la estatura al cuadrado (IMC = P/E**2).
La variable respuesta es el tiempo al recorrer 100 metros planos (en segundos). Los
investigadores consideran que una diferencia de 2 segundos entre dos promedios es
relevante.

factores -> tipo de salida y calentamientos

* calentamiento 
-A solo estirando
-B calentamiento normal 
-C calentamiento para correr 

* salida
+ salida baja con 4 apoyes 
- salida normal de pie 

covariable -> imc 

respuesta -> tiempo(en segundos)

diff relevante -> 2 segundos




# 1. carrera 100 metros
(a) Cargue el archivo 100metros.Rdata.
```{r include=FALSE}
load("Bases/100metros.Rdata")
```

(b) A partir del peso y la estatura cree la variable imc.
```{r}
# P/E**2
base$imc=base$peso/base$estatura**2
```

(c) ¿Cuántos tratamientos tiene este experimento tomando en cuenta solo los
factores de diseño?

**En total son 6 tratamientos**

(d) ¿Cuántas repeticiones hay en cada tratamiento?
```{r}
table(base$salida,base$calent)
```
**Son 11 repeticiones por tratamien**
2. Linealidad:
(a) En este caso se tiene una covariable (imc) que se incluye porque se sabe
que el tiempo está asociado linealmente al índice de masa corporal como
se verá con el cálculo de las correlaciones. Primero obtenga el coeficiente
de correlación lineal entre la respuesta y la covariable.
```{r}
cor(base$tiempo,base$imc)
```

(b) Obtenga los coeficientes de correlación dentro cada uno de los
tratamientos. Use la función summarise en la librería dplyr, de la siguiente
forma: summarise(group_by(base,A,B),cor(X,Y)), donde A y B son los
factores que definen los grupos.
```{r}
summarise(group_by(base,calent,salida),cor(tiempo,imc))
```
**Se obtiene que dentro de cada tratamiento, hay correlaciones mas altas que la general**

(c) Es importante verificar que la relación que existe entre la respuesta y
la covariable es lineal dentro de cada tratamiento. Para esto haga un
gráfico usando la función scatterplot de la librería car de la siguiente
forma: scatterplot(y~x); para hacer un gráfico para un solo tratamiento
delimite la base de la siguiente forma: data=base[basecalent ==
”A”basesalida==",]. Observe cada par de líneas, la línea recta indica una
relación lineal perfecta, mientras que la línea curva sigue los datos. Si
ambas son parecidas es porque sí hay una relación lineal entre la covariable
y la respuesta.
```{r}
scatterplot(tiempo~imc,data = base[base$calent=="A"& base$salida=="-",])
```

3. Variabilidad de la respuesta:
(a) Obtenga la variancia de la respuesta dentro de cada tratamiento.
```{r}
v=tapply(base$tiempo,list(base$calent,base$salida),var);v
```

(b) Obtenga una estimación de la variancia dentro de los tratamientos
asumiendo homocedasticidad.
```{r}
mean(v)
```

(c) Para visualizar la variabilidad dentro de cada tratamiento haga primero un
gráfico del tiempo por tratamiento incluyendo ambos factores de diseño.
```{r}
boxplot(base$tiempo~base$calent+base$salida)
```

(d) Ahora se tratará de visualizar la variabilidad de la respuesta tomando en
cuenta la covariable. Haga un gráfico de puntos del tiempo contra imc
agregando una línea de regresión para cada tipo de tratamiento. Ponga los
dos factores dentro de la función: xyplot(Y~X|A+B,type=c("r","p")) en
la librería lattice..
```{r}
xyplot(tiempo~imc|calent+salida,type=c("r","p"),data = base)
xyplot(tiempo~imc,groups=calent,type=c("r","p"),data = base)
```


(e) Observe la variabilidad que hay en cada tipo de calentamiento y en
cada tratamiento. Primero observe como varían todos los puntos de un
mismo tipo de calentamiento y un mismo tratamiento, luego vea la
variabilidad de los puntos de un mismo tipo de calentamiento y un
mismo tratamiento en un intervalo de imc muy corto. Haga este ejercicio
visualmente haciendo pequeños intervalos de imc.

4. Inclusión de covariable:
(a) Para tomar en cuenta la variabilidad que está induciendo el imc, se
debe hacer un modelo con los factores y la covariable. Puede incluir la
interacción entre los dos factores de diseño. Obtenga los residuales del
modelo.
```{r}
mod0=lm(tiempo~calent*salida+imc,data=base)
anova(mod0)
r=mod0$residuals
```
(b) ¿Qué representa cada uno de estos residuales?

**Estos representan la distancia de las observaciones a su media estimada por tratamiento (linea de regresion)**

(c) Obtenga el cuadrado medio residual del modelo a partir de los residuales.
```{r}
cmres=sum(r**2)/59;cmres
anova(mod0)[5,3]
```

(d) Compare el cuadrado medio residual obtenido en este modelo con la
estimación de la variancia por tratamiento que obtuvo al principio.
```{r}
cbind(cmres,mean.v=mean(v))
```

5. Prueba formal: para estudiar el efecto de los factores de diseño es importante
tomar en cuenta que el imc introduce mucho ruido. Sería ideal tener a todas las
personas con valores específicos de imc. Resulta muy complicado hacer grupos
por imc puesto que es una variable continua difícil de controlar.
(a) Estime un modelo con los dos factores de diseño pero no incluya el imc.
Plantee este modelo cambiando el orden de los factores. Obtenga el anova
de ambos modelos y observe si hay cambios.
```{r}
mod1a=lm(tiempo~calent*salida,data=base);anova(mod1a)
mod1b=lm(tiempo~salida*calent,data=base);anova(mod1b)
```
**No hay cambios**
(b) Haga la prueba de hipótesis correspondiente para determinar si alguno
de los tipos de calentamiento produce una media de tiempo diferente.
Observe la probabilidad asociada.
```{r}
mod2=lm(tiempo~calent*salida,data=base);anova(mod2)
```
**Se rechaza la hipotesis de igualdad de medias, por lo que hay evidencia de que hay un tipo de calentamiento que produce un tiempo promedio menor que los demas, con una p asociada de 0.02**

(c) Ahora tome en cuenta la covariable introduciéndola en un modelo. Hágalo
sin tomar en cuenta la interacción entre los factores de diseño. Hágalo
colocando primero los factores y luego la covariable y al contrario.
```{r}
mod3a=lm(tiempo~calent+salida+imc,data=base);anova(mod3a)
mod3b=lm(tiempo~imc+salida+calent,data=base);anova(mod3b)
```


(d) Puesto que el anova en este caso se ve afectado por el orden en que se
introducen los factores, siempre se debe colocar de último el factor que
se está poniendo a prueba. Para entender lo que hace este anova corra
dos modelos: 1) con los dos factores de diseño y la covariable, 2) solo con
salida y la covariable. Representamos con Ω al modelo más grande y con
ω al modelo más pequeño.
```{r}
mod5a=lm(tiempo~calent+salida+imc,data=base);anova(mod5a)
mod5b=lm(tiempo~salida+imc,data=base);anova(mod5b)
```


(e) Encuentre la SCRes de ambos modelos que los representamos como
SCResΩ y SCResω. A partir de ellas obtenga la suma de cuadrados de
regresión marginal como SCRegMar = SCResω−SCResΩ, la cual representa
la parte de la variabilidad de la respuesta que es explicada por
calentamiento cuando entra después de las otras dos variables.
```{r}
scres1=anova(mod5a)[4,2]
scres2=anova(mod5b)[3,2]

screg=scres2-scres1;screg
```

(f) Construya el estadístico F y haga la prueba de la hipótesis obteniendo la
probabilidad asociada a este valor de F en una distribución que tiene los
grados de libertad usados en la construcción de la misma.
```{r}
cmreg=screg/2 #gl=2
cmres=3.63 #gl=61
f=cmreg/cmres
pf(f,2,61,lower.tail = F)

```

(g) La prueba correcta se puede hacer siempre de forma segura con la función
drop1, a la cual hay que agregar el agrumento test="F", que permite
comparar dos modelos, uno con la variable a probar y otro sin ella.
```{r}
mod.d=lm(tiempo~salida+calent+imc,data = base)
drop1(mod.d,test="F")
```

(h) Observe la probabilidad asociada al factor de calentamiento y compárela
con la que se había obtenido en el anova que no consideraba el imc.
```{r}
mod.d2=lm(tiempo~calent+salida,data = base);anova(mod.d2)
```
**La probabilidad asociada es mucho mas baja en el que incluye imc, lo que nos indica que disminuye la variabilidad al introducir la cov**

6. Prueba de interacción: considere la interacción entre los dos factores de diseño
(si se siguiera un orden lógico, esto sería lo primero que debería probarse).
```{r}
mod=lm(tiempo~calent*salida+imc,data = base);anova(mod)
```

(a) Tome el modelo que contiene la interacción entre esos dos factores y
además contiene la covariable. Usando el drop1 puede verificar la hipótesis
de no interacción.
```{r}
drop1(mod,test = "F")
```
**Se acepta H0, no hay interaccion**

7. Comparaciones finales: en este tipo de análisis puede resultar más conveniente
usar el modelo de tratamiento referencia. En cualquiera de los dos modelos
el intercepto no representa la media general. La dirección de las comparaciones
se hace basada en los coeficientes del factor que se analiza, recordando que el
tratamiento referencia tiene un coeficiente igual a cero.
(a) Escriba el modelo resultante.

(b) Investigue con cuál tipo de calentamiento se puede esperar el menor
tiempo promedio.

```{r}
mod4a=lm(tiempo~calent+salida+imc,data=base)
tapply(base$tiempo,base$calent,mean)

#coeficientes
b=mod4a$coefficients;b

#marginales 
A=c(1,0,0,0,0)
B=c(1,1,0,0,0)
C=c(1,0,1,0,0)

#contrastes
BA=B-A
BC=B-C
CA=C-A

#matriz de contrastes
cont=cbind(BA,BC,CA)
L=t(cont)%*%b;L

#error
ee=sqrt(diag(t(cont)%*%vcov(mod4a)%*%cont))
qt=L/ee
#probabilidades asociadas a los contrastes
p=pt(qt,61,lower.tail = F);p
#significancia a comparar(bonferroni)
0.05/3
```
**hay dos significativas, BA y BC esto comparado con un a/3 = 0.017**

calculo de cotas inferiores
```{r}
#correc de bonferoni, 2 = grupos significativos
qt=qt(1-0.05/2,61) #prop, gl
(lim=L[1:2]-qt*ee[1:2])
```

# asfalto
Se hizo un estudio cuyo objetivo era investigar si al implementar antioxidantes
como aditivos para el mortero asfáltico (agregado + asfalto), se retarda el proceso
de oxidación. Se utilizan dos variables como indicadores de este proceso: el módulo
complejo (MegaPascales) y el ángulo de fase (grados). En el estudio se quieren
comparar 2 antioxidantes (ácido ascórbico y orujo), donde cada uno de ellos se utiliza
en tres diferentes concentraciones (1, 3 y 5%).
Además de los factores de diseño, se sabe que los resultados de las variables críticas
se miden a temperaturas y frecuencias determinadas, las cuales van a impactar estos
resultados. Estas temperaturas y frecuencias también se obtienen para períodos de
envejecimiento determinados (4, 8 y 16 años). Adicionalmente se tienen dos fuentes
de donde proviene el agregado o piedra fina (Barranca y Guápiles). Si bien el conocer
el efecto de la fuente de agregado no es el objetivo primordial del estudio, podría
darse que la fuente introduzca variabilidad en los resultados.
Puesto que las dos variables respuesta están altamente correlacionadas, el
investigador decide concentrar su análisis en el módulo. Él considera que una
diferencia de 10 MegaPascales entre dos promedios es bastante considerable. El
antioxidante que tenga un módulo promedio menor se considera más apropiado.

1. Preparación:
(a) Cargue el archivo asfalto.Rdata. Para iniciar se van a considerar solo los
datos para una concentración de 5% que corresponde al nivel alto en la
variable concentración. Cambie los niveles de agregado a las iniciales de
cada sitio para que sea más fácil de leer en los análisis. Haga una nueva
base donde se filtren sólo los los datos que se requieren.
```{r include=FALSE}
load("Bases/asfalto.Rdata")
base2=subset(base,base$conc=="alto")
```

(b) ¿Cuáles son los factores de diseño? ¿Cuántos tratamientos tiene este
experimento?

**el factor de diseño es antiox, ademas con el factor de contracion fijado**

* tratamientos 
-conc.alto,antiox.ascor 
-conc.alto,antiox.oruja


(c) ¿Cuántas repeticiones hay en cada tratamiento?
```{r}
table(base2$antiox)
```
* hay 180 repeticiones por cada tratamiento 

(d) Puesto que el envejecimiento y el agregado son dos factores que se
controlan, se van a incluir en el análisis para reducir el ruido. Al incluir
estos dos nuevos factores, ¿cuántas combinaciones tratamiento-factor se
obtienen?

*2 antiox
*3 envejecimientos
*2 agragados

**se obtienen 2x3x2 da un total de 12 combinaciones trat-factor**


(e) ¿Cuántas repeticiones hay en cada combinación?
```{r}
with(base2,table(antiox,env,agreg))
```

# 2. Variabilidad de la respuesta:
(a) Obtenga la variancia de la respuesta para cada antioxidante y la media de
estas variancias.
```{r}
v=tapply(base2$mod,base2$antiox,var);v
x1=mean(v);x1

```

(b) Obtenga la variancia de la respuesta dentro de cada combinación
tratamiento-factor y la media de estas variancias. Compare esta medida
de la variabilidad con la que había obtenido anteriormente.
```{r}
x2=summarise(group_by(base2,antiox,env,agreg),var(mod));x2
v2=mean(as.matrix(x2[,4]));v2
cbind(x1,v2)
```
(c) Para visualizar la variabilidad dentro de cada tratamiento haga primero un
gráfico del módulo por tratamiento. Al lado haga un gráfico del módulo
por combinación tratamiento-factor. Observe que las etiquetas del eje X
son muy largas por lo que no caben, entonces se pueden voltear usando
las=2 en el boxplot.
```{r}
boxplot(mod~antiox,col=c(2,4),xlab="antioxidante",ylab="módulo",data=base2)
boxplot(mod~antiox+agreg+env,col=c(2,4),cex.axis=0.5,las=2,
xlab="antioxidante-fuente-envejecimiento",ylab="módulo",data=base2)
```
(d) Discuta si el haber agregado los factores controlados disminuyó la
variabilidad, de tal forma que sea más evidente si uno de los antioxidantes
es mejor que el otro en términos del promedio de módulo.

**El agregar estos factores disminuye la variabilidad de la respuesta, se pueden apreciar mejor las diferencias entre los promedios de las respuestas segun el factor de diseño**

3. Inclusión de covariable: ahora se tratará de visualizar la variabilidad de la
respuesta tomando en cuenta una de las covariables. En este caso se tienen dos
covariables (temperatura y frecuencia) que se incluyen porque se sabe que el
módulo está asociado con la temperatura y con la frecuencia.
(a) Obtenga la correlación entre la respuesta y cada una de las covariables.
```{r}
cor(base2$frec,base2$mod)
cor(base2$temp,base2$mod)
```

(b) Obtenga estas mismas correlaciones pero dentro de cada uno de los niveles
de antioxidante.
```{r}
cor(base2$frec[base2$antiox=="ASC"],base2$mod[base2$antiox=="ASC"])
cor(base2$frec[base2$antiox=="OR"],base2$mod[base2$antiox=="OR"])
cor(base2$temp[base2$antiox=="ASC"],base2$mod[base2$antiox=="ASC"])
cor(base2$temp[base2$antiox=="OR"],base2$mod[base2$antiox=="OR"])
```

(c) Haga un grafico de puntos del módulo contra la temperatura agregando
una línea de regresión para cada antioxidante. En la librería lattice,
use xyplot(Y~X,groups=F,type=c("r")), donde Y es la respuesta, X es la
covariable y F es el factor.
```{r}
xyplot(mod~temp,groups=antiox,type=c("r","p"),data=base2)
xyplot(mod~temp|antiox,type=c("r","p"),data=base2)
```


(d) Observe la variabilidad que hay alrededor de cada línea. Si hace una
relación con un modelo de regresión, ¿a qué concepto corresponde esta
variabilidad?
(e) Aunque la temperatura es una variable continua, en este caso se nota que
hay datos agrupados en 5 rangos de temperatura, y se cuenta con otra
variable que solo indica el rango de temperatura en su punto medio (esta
variable es temp2). Esto permite que se pueda visualizar la variabilidad
que hay alrededor de cada media usando un boxplot. En una sola ventana
dividida en tres partes, repita los dos boxplots que hizo anteriormente y
agregue otro boxplot con el módulo contra la combinación de antioxidante
y temperatura (temp2).

```{r}
boxplot(mod~antiox,col=c(2,4),xlab="antioxidante",ylab="módulo",data=base2)
boxplot(mod~antiox+agreg+env,col=c(2,4),cex.axis=0.5,las=2,
xlab="antioxidante-fuente-envejecimiento",ylab="módulo",data=base2)
boxplot(mod~antiox+temp2,col=c(2,4),cex.axis=0.5,las=2,xlab="antioxidante-temp2",ylab="módulo",data=base2)
```

(f) Para tomar en cuenta la variabilidad que está induciendo la temperatura,
estime un modelo con el factor antioxidante y la covariable temperatura
(use la temperatura continua original - temp). También estime un modelo
donde sólo se tiene el factor de diseño antioxidante.

```{r}
mod0=lm(mod~temp+antiox,data=base2)
mod02=lm(mod~antiox,data=base2)
```

(g) Obtenga el cuadrado medio residual en ambos modelos. Compare los
resultados entre sí y compárelos con la estimación de la variancia por
tratamiento original.
```{r}
anova(mod0)[3,3]
anova(mod02)[2,3]
mean(v)
v2
```

# 4. Prueba formal:
(a) Haga la prueba de hipótesis correspondiente para determinar si alguno
de los antioxidantes es mejor en términos de reducir el módulo promedio.
Hágalo primero en un análisis de variancia que solo considere el factor
de diseño, luego tome en cuenta la temperatura. Cuando se tienen
covariables hay que tener cuidado con el uso de la función anova ya que
cada línea representa el aporte marginal de cada variable. En este caso
interesa analizar la variabilidad que explica el antioxidante una vez que
se ha eliminado el ruido que introduce la temperatura, por esto, debe
introducirse primero la temperatura y luego el antioxidante. En general es
más recomendable usar la función drop1, indicando test="F", para evitar
confusiones.
```{r}
mod1=lm(mod~antiox+temp,data=base2);anova(mod1)
mod12=lm(mod~antiox,data=base2);anova(mod12)
mod13=lm(mod~temp+antiox,data = base2);anova(mod13)
drop1(mod1,test = "F")
```


(b) ¿Cuál es el papel de la temperatura en el análisis?

**Su papel es el de una covariable capaz de reducir la variabilidad de la respuesta, permitiendo detectar diferencias entre los promedios del factor de diseño de una manera mas clara**

5. Análisis completo: ahora vamos a realizar el análisis tomando en cuenta todos
los factores incluidos en el estudio. Para esto vemos que hay dos covariables
(temperatura y frecuencia), y también se tienen el envejecimiento y el agregado
además del factor de diseño (antioxidante). Para que las interpretaciones
no sean tan complicadas es deseable que no exista interacción entre factor
de diseño y las covariables continuas. El modelo inicial debe incluir estas
interacciones para probar si el supuesto de no interacción se cumple. Además
deben incluirse interacciones entre el factor de diseño y otros factores incluidos
en el análisis.
En el modelo se usa la siguiente notación: i para antioxidante, j para
envejecimiento, k para agregado, X_1 para temperatura y X_2 para frecuencia.
Se usa el término α(1)i para referirse a la interacción entre antioxidante
y temperatura, y α(2)i para referirse a la interacción entre antioxidante y
frecuencia. El modelo completo es el siguiente:
µijk,X1,X2 = β0 +αi +δj +τk +β1X1 +β2X2 + (αδ)ij + (ατ)ik +α(1)iX1 +α(2)iX2

(a) Compare el modelo completo contra otro modelo donde no hay
interacciones entre el factor de diseño y las covariables. Debe estimar
dos modelos: 1) el modelo completo y 2) el modelo donde no tenga las
interacciones que se mencionan. Luego debe comparar los dos modelos
con anova(mod.pequeño,mod.grande). Establezca la hipótesis nula que se
va a probar y concluya.
```{r}
mod5.1=lm(mod~antiox*env+antiox*agreg+antiox*temp+antiox*frec,data=base2)
mod5.2=lm(mod~antiox*env+antiox*agreg+temp+frec,data=base2)
anova(mod5.2,mod5.1)
```
La hipótesis nula es que los dos modelos dan una misma explicación, lo que
implica que \(\alpha^{(1)}_i = \alpha^{(2)}_i = 0.\) Al comparar los dos modelos se obtiene una
probabilidad de error tipo I de 0,55, lo cual lleva a no rechazar la hipótesis nula
y se puede asumir que ambos modelos explican lo mismo, es decir, que no existe
interacción entre antioxidante y cada una de las covariables.

(b) Ahora haga un proceso de selección hacia atrás para ir descartando
interacciones entre el factor de diseño y los otros factores. Use la función
drop1(mod,test="F"). En este caso debe empezar con el modelo donde ya
se eliminaron las interacciones con las covariables.
```{r}
drop1(mod5.2,test = "F")
mod5.3=lm(mod~antiox*env+agreg+temp+frec,data=base2)
drop1(mod5.3,test="F")
```
**modelo final**
mod5.3=lm(mod~antiox*env+agreg+temp+frec,data=base2)

(c) Haga un gráfico del módulo contra envejecimiento diferenciando por
antioxidante. Use xyplot con type=c("a"). Puesto que se encontró una
interacción entre antioxidante y envejecimiento, trate de explicar con el
gráfico por qué se da esa interacción.
```{r}
xyplot(mod~env,groups=antiox,type=c("a"),data=base2)
xyplot(mod~env|antiox,type=c("a"),data=base2)
```
**al inicio la diferencia de promedios es mayor pero con el paso de los años la diferencia va disminuyendo entre los dos antiox**

(d) Escriba el modelo resultante.
**modelo final**
mod5.3=lm(mod~antiox*env+agreg+temp+frec,data=base2)

(e) Debido a la presencia de interacción, para hacer intervalos de confianza
al comparar las medias de módulo entre los dos antioxidantes, debe
considerarse el envejecimiento, pero no es importante considerar el
agregado, la temperatura o la frecuencia. Deben hacerse tres intervalos
de confianza, uno para cada nivel de envejecimiento. Puesto que se nota
que el promedio para ASC es siempre mayor que para OR, es importante
ver la media de ASC menos la de OR para cada nivel de envejecimiento.
Verifique cuál es el nivel de referencia para antioxidante y envejecimiento.

*consideramos solo env
*se hacen tres intercalos uno para cada nivel de env
```{r}
contrasts(base2$antiox)
```

```{r}
contrasts(base2$env)
```

(f) Se está usando el modelo de tratamiento de referencia y la referencia
es ASC para antioxidante y 4 para envejecimiento, es decir que i=1 para
ASC, i=2 para OR, j=1 para 4, j=2 para 8, j=3 para 16. Entonces α1 =
δ1 = 0, además (αδ)11 = (αδ)12 = (αδ)13 = (αδ)21 = 0. Usamos la siguiente
notación: µij para indicar la media del antioxiante i y el envejecimiento j,
para un agregado cualquiera, para una temperatura fija y una frecuencia
fija. Verifique las siguientes relaciones:
µ11 −µ21 = −α2
µ12 −µ22 = −α2 −(αδ)22
µ13 −µ23 = −α2 −(αδ)23
(g) Observe los coeficientes del modelo y escriba los coeficientes para los tres
contrastes escritos anteriormente.
```{r}
coe=mod5.3$coefficients;coe
summary(mod5.3)
```
```{r}
mu11=c(1,0,0,0,0,0,0,0,0)
mu21=c(1,1,0,0,0,0,0,0,0)
mu12=c(1,0,1,0,0,0,0,0,0)
mu22=c(1,1,1,0,0,0,0,1,0)
mu13=c(1,0,0,1,0,0,0,0,0)
mu23=c(1,1,0,1,0,0,0,0,1)

ASC.4_OR.4=mu11-mu21
ASC.8_OR.8=c2=mu12-mu22
ASC.16_OR.16=c3=mu13-mu23



```

(h) Obtenga las estimaciones de los contrastes.
```{r}
cont=cbind(ASC.4_OR.4,ASC.8_OR.8,ASC.16_OR.16)
L=t(cont)%*%coe;L 
```

(i) Verifique la hipótesis para cada contraste usando solo una cola, es decir,
poniendo la alternativa H1 : L > 0. Debe verificar si los contrastes son
ortogonales para decidir si debe ajustar el α.

**Son ortogonales por su independencia por cada contraste**

```{r}
ee=sqrt(diag(t(cont)%*%vcov(mod5.3)%*%cont))
t=L/ee
#dos formas de obtener los gl 
gl=nrow(base2)-length(mod5.3$coefficients)
#la otra usar los residuales del mod
anova(mod5.3)[7,1]

p=pt(t,gl,lower.tail = F);round(p,4)
```

(j) Construya cotas inferiores con 95% de confianza en los casos de 4 y 8 años
e interprete el resultado según la relevancia que estableció el investigador.
```{r}
qt=qt(1-0.05,gl)
lim=L[1:2]-qt*ee[1:2];lim

```
**obtenemos como resultado que la diferencia en modulo entre los dos antioxidantes es relevante en los primeros 4 años ya que la cota inferior para estos es de 11.8804, pero conforme el pasa el tiempo esta diferencia va disminuyendo hasta el punto en el que no es significativa para 16 años y no es relevante para 8 años la diferencia entre los dos acidos es de 2.4256, siendo en los dos casos mayor el promedio de modulo del antioxidante asc respecto a or **

