---
title: "Reporte de analisis Abejas polinizadoras"
author: "Cesar Pe√±aranda, Keyla, Kevin"
output:
  html_document: default
  pdf_document: default
date: "2023-11-11"
---
# Anotaciones 
* No podemos utilizar la quasipoisson con un glmer obtenemos el siguiente error
```{r eval=FALSE}
Error in lme4::glFormula(formula = conteo ~ especie * mes + (1 | zona) + :
"quasi" families cannot be used in glmer
```

* Vamos a analizar el efecto del tiempo y la zona en las especies

* El mes no es un bloque, es una medida repetida

* Buscar manera de probar la H0 de distribucion de poisson

* Buscar como ver la realcion entre mes y la especie

* Se intento agregar el mes como factor pero complico el analisis (Preguntar si es incorrecto)

- Librerias
```{r}
library(lattice)
library(emmeans)
library(lme4)
library(dplyr)
```

- Codigos de mes
```{r eval=FALSE}
noviembre2018 = 1
marzo2019     = 2
abril2019     = 3
octubre2019   = 4
noviembre2019 = 5
marzo2020     = 6
```


- Codigos de especie
```{r eval=FALSE}

Apis_mellifera       = "apis"
Euglossa_viridissima = "euglo"
Polybia_occidentalis = "poly"
Toxomerus_2          = "toxo"
Trigona_corvina      = "trigo"
```

- Carga de la base
```{r}
load("bases/base_abejas.Rdata")
levels(base_abejas$especie)=c("apis","euglo","poly","toxo","trigo")
#base_abejas$mes=factor(base_abejas$mes)
#levels(base_abejas$mes)=c("M1","M2","M3","M4","M5","M6")
str(base_abejas)
```

Columna del total
```{r}
total <- base_abejas %>%
  group_by(zona, mes) %>%
  mutate(x = sum(conteo))
print(total)
base_abejas$total=total$x
```

```{r}
base_abejas %>% arrange(zona)
```

- Graficos
```{r}
#Proporcion de la especie segun finca y mes
xyplot(conteo/total~mes|zona,group=especie,type=c("a","p"),data=base_abejas,auto.key=list(columns=5))
```
- Modelo inicial
```{r}
mod0=glm(conteo~especie*zona+mes,family = poisson,data = base_abejas)
library(AER)
#quasi-Poisson
dispersiontest(mod0,trafo = 1)
#binomial negativa
dispersiontest(mod0,trafo = 2)
```

- Modelo aleatorio
```{r}
mod0=glmer(conteo~especie*mes+(1|zona)+(mes|zona),family = poisson,data = base_abejas)
summary(mod0)
```

- Pruebas formales
```{r}
#Prueba H0 independencia entre pendientes e interceptos aleatorios
mod1=glmer(conteo~especie*mes+(1|zona)+(0+mes|zona),family = poisson,data = base_abejas)
mod2=glmer(conteo~especie*mes+(mes|zona),family = poisson,data = base_abejas)
anova(mod1,mod2)
```
**No hay suficiente evidencia estadistica para rechazar H0**

```{r}
#H0 pendientes aleatorios iguales
mod1=glmer(conteo~especie*mes+(1|zona)+(0+mes|zona),family = poisson,data = base_abejas)
mod3=glmer(conteo~especie*mes+(1|zona),family = poisson,data = base_abejas)
anova(mod1,mod3)
```
**No hay suficiente evidencia estadistica para rechazar H0**

```{r}
#H0 independencia entre mes y especie
mod3=glmer(conteo~especie*mes+(1|zona),family = poisson,data = base_abejas)
mod4=glmer(conteo~especie+mes+(1|zona),family = poisson,data = base_abejas)
anova(mod3,mod4)
```
**Se rechaza H0, por lo que mes y especie no son independientes**

```{r}
summary(mod3)
```
```{r}
#Aun no ha cargado (es mucha carga para la pc)
confint(mod3)
```

- Contrastes
```{r}
emmeans(mod3, pairwise~especie|mes, adjust="bonferroni")
```

- Graficos
```{r}
#Pendientes de la especie segun finca y mes
xyplot(conteo~mes|zona,group=especie,type="r",data=base_abejas,auto.key=list(columns=5))
```