---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
date: "2023-05-15"
---
#3.2 Tortugas 1

Se desea determinar si la falta de alimento afecta el nivel de proteínas en sangre en
tortugas de la especie Chelonia midas (de agua salada) y si afecta de forma diferente
a los machos que a las hembras. Se escogen 8 machos y 8 hembras. A cada uno se
le asigna aleatoriamente una de las siguientes condiciones: 1) dieta regulada y 2)
alimento en abundancia. Se registra el nivel de proteína en gramos por decilitro.

#3.2.1 Ejercicios

#1. Preparación:
#(a) Cargue el archivo tortugas1.csv.
Verifique que las variables género y condición sean factores con los niveles adecuados. Los códigos para género
corresponden a macho (1) y a hembra (2).

```{r}
base=read.csv("Bases/tortugas1.csv")
str(base)
class(base$genero);class(base$cond) #verificacion del tipo de variable en genero y cond
base$genero=as.factor(base$genero) 
base$cond=as.factor(base$cond)
class(base$genero);class(base$cond)
levels(base$genero) #verificacion de los niveles en genero
levels(base$genero)=c("macho","hembra") ; levels(base$cond) #rebautizando los condigos de 1 y 2 
View(base)
```

#(b) ¿Cuáles son los factores que se incluyen en el experimento?
En este caso los factores de interes en el experimento es la condicion de alimento (dieta regulada y alimento en abundancia)
y el factor sexo (macho y hembra)

#(c) Comente sobre las características de los factores y sobre el alcance del experimento.
Las en este caso los factores son dicotomicos (macho, hembra)(dieta,alimento) creando entre los dos factores un total de 4 niveles 
ademas, el experimento espera indicar los efectos de la dieta en la proteina en sangre y si ademas hay alguna relacion entre la dieta 
y el sexo sobre la proteina en sangre (interaccion)

#(d) ¿En qué aspectos se debe concentrar el análisis?
Primeramente se puede analizar si hay interaccion entre los factores, para luego dar conclusiones dependiendo 
de los resultados anteriores a los efectos de la dieta en la proteina en sangre independientemente del sexo

#(e) ¿Cuántos tratamientos tiene este experimento?
4 tretamientos:
macho-dieta
macho-alimento 
hembra-dieta
hembra-alimento

#(f) Verifique el número de repeticiones por tratamiento.
```{r}
table(base$genero,base$cond)
```


#2. Efectos:
#(a) Obtenga la media general de la respuesta.
```{r}
m=mean(base$proteina)
m
```

#(b) Obtenga los efectos simples de cada condición
es decir, las diferencias entre cada media de condición y la media general. Esto es similar a los
τ cuando hay un solo factor, pero se van a llamar α1 y α2.
```{r}
alfa=tapply(base$proteina,base$cond,mean)-m
mean(base$proteina[base$cond=="alimento"])-m#para verificar
alfa
```

#(c) Obtenga los efectos simples de cada género (β1 y β2).
```{r}
beta=tapply(base$proteina,base$genero,mean)-m
```

#(d) Obtenga los promedios observados de los 4 tratamientos.
Use tapply, pero haga una lista con los factores para que los cruce y obtenga la media para
cada combinación o tratamiento: tapply(Y,list(X1,X2),mean).

```{r}
m_ob=tapply(base$proteina,list(base$genero,base$cond),mean)
m_ob
```

#(e) Obtenga los promedios estimados bajo el modelo sin interacción. 
Realice los cálculos correspondientes manualmente.
```{r}
m11=m+alfa[1]+beta[1]
m12=m+alfa[1]+beta[2]
m21=m+alfa[2]+beta[1]
m22=m+alfa[2]+beta[2]

c=c(m11,m12,m21,m22)
names(c)=c("m11","m12","m21","m22")
c
```

#(f) Compare los promedios estimados bajo el modelo sin interacción con los promedios observados.
```{r}
c1=c(m_ob[1,1],m_ob[1,2],m_ob[2,1],m_ob[2,2])
names(c1)=c("m11","m12","m21","m22")
c1
round(c,3)
```

#(g) Obtenga un gráfico
de los valores de proteína separados por género para
interpretar gráficamente si existe interacción entre condición y género.
Recuerde el objetivo del estudio y vea qué es más conveniente que
aparezca en el eje X. Use el comando ggplot de la librería ggplot2. En
este caso se coloca género en el eje X, proteína en el eje Y, y la condición
es el factor que se declara en el argumento group. La instrucción se escribe
en dos partes que se unen por un símbolo +. La primera de ellas contiene
la definición de las variables dentro del argumento aes, de esta forma:
ggplot(base, aes(x=genero, y=proteina, group = cond)).
La segunda parte indica que debe unir los promedios de cada condición
usando el argumento stat_summary y que debe usar un tipo de línea para
cada condición, de esta forma:
stat_summary(fun.y="mean", geom="line",aes(linetype = cond)).
```{r}
library(ggplot2)

ggplot(base, aes(x = genero, y = proteina,group=cond)) +
  stat_summary(fun="mean", geom="line",aes(linetype = cond))

```


#(h) Observe la distancia que hay entre cada par de medias para cada género,
es decir, la media en alimento contra dieta para machos y para hembras.
#(i) Obtenga los efectos simples usando la función model.tables. 
Escriba primero el modelo con condición y género con la función aov.
```{r}
mod=lm(base$proteina~base$cond+base$genero)
aov=aov(mod)
model.tables(aov)
```

#3. Efectos de interacción en el modelo:
#(a) Escriba el modelo con interacción utilizando lm (llámelo mod2).
Cambie al modelo de suma nula. Escriba el modelo con interacción entre condición
y género. La interacción se agrega en un modelo de cualquiera de las
siguientes formas: Y~X1+X2+X1:X2 o Y~X1*X2.
```{r}
options(contrasts=c("contr.sum","contr.poly"))
mod2=lm(base$proteina~base$cond*base$genero)
```

#(b) Observe la matriz de estructura usando model.matrix(mod2). 
Vea a qué corresponde cada columna. Ponga atención a los códigos y relaciónelos
con los niveles de cada factor.
```{r}
model.matrix(mod2)
```

#(c) Extraiga los coeficientes.
Observe el efecto de la interacción. ¿Qué representa esta cantidad?
```{r}
mod2$coef

mean(base$proteina[base$cond=="dieta"& base$genero=="hembra"])-m22
```
representa la interacion que hay entre el factor cond y el factor sexo
o tambien se puede ver como la diferencia del modelo CI y el modelo SI 

#4. Variancia del error:
#(a) Obtenga las variancias de los 4 tratamientos.
```{r}
v=tapply(base$proteina,list(base$cond,base$genero),var)
var(base$proteina[base$cond=="alimento" & base$genero=="macho"])
v
```

#(b) Verifique si se cumple el supuesto de homocedasticidad.
Use la prueba de Bartlett con la función bartlett.test indicando Y~interaction(X1,X2).
```{r}
plot(residuals(mod2))
bartlett.test(base$proteina~interaction(base$cond,base$genero))
```

#(c) Obtenga una medida de la variabilidad del error asumiendo homocedasticidad.
```{r}
var_err=mean(v)
var_err
```

#5. Prueba de hipótesis para la interacción:
#(a) Obtenga la tabla de análisis de variancia 
para probar la hipótesis de NO interacción entre condición y género.
```{r}
anova(mod2)
```

#(b) Escriba la hipótesis nula que interesa probar con símbolos y con palabras.

H0:(AB)_ij=0
se desea probar que la interacion entre el factor sexo y el factor cond es igual a cero


#(c) Observe el cuadrado medio residual y compárelo con la estimación de
la variancia del error obtenida más arriba. Interprete de esta forma qué
significa el cuadrado medio residual.

```{r}
c2=c(anova(mod2)[4,3],var_err)
names(c2)=c("Mean Sq res","var_err")
c2
```
este es igual a la varianza del error, el Cuadrado Medio Residual es una medida de la
variabilidad de los residuales en conjunto.


(d) Interprete qué se está midiendo con el cuadrado medio de interacción.
```{r}
anova(mod2)[3,3]
```
esta mide la variacion debida a la interacion de los factores

(e) Observe en la columna de F el valor asociado a la hipótesis y concluya.
```{r}
anova(mod2)[3,5]
CMI=0.180625
CMRES=var_err
F_=CMI/CMRES
round(F_,3)

c3=c(round(F_,5),round(anova(mod2)[3,4],5))
names(c3)=c("F a pie","F anova")
c3

pf(F_,1,12,lower.tail = F)#1 grados de libertad del numerador y 12 de denominador
```
puesto que la H0 era (AB)_ij=0 y en este caso no hay suficiente evidencia estadistica para rechazarla, se concluye que 
no hay suficiente evidencia para argumentar interaccion entre el factor sex y el factor cond, debido a esto se decide trabajar con
el modelo SI ya que asumimos no interaccion
#6. Estimaciones bajo el modelo sin interacción:

#(a) Puesto que se decidió asumir que no hay interacción entre condición
y género, ahora se procede a usar el modelo sin interacción. Escriba el
modelo sin interacción con lm y llámelo mod3.
```{r}
mod3=lm(base$proteina~base$cond+base$genero)
```

#(b) ¿Cuánto es el efecto simple de cada condición y cada género? ¿Cómo se interpretan?
```{r}
mod3$coefficients
c4=c(
mean(base$proteina[base$genero=="macho"])-m,
mean(base$proteina[base$genero=="hembra"])-m,
mean(base$proteina[base$cond=="dieta"])-m,
mean(base$proteina[base$cond=="alimento"])-m)
names(c4)=c("macho","hembra","dieta","alimento")
c4
```

alimento tiene aumenta de 1.56 gr/ml la proteina en sangre con respecto a la media,
mientras que la dieta disminuye 1.56 gr/ml la proteina en sangre con respecto a la media.
por otra parte los machos aumentan 1.92 gr/ml de proteina en sangre con respecto a la media general
mientras que las hembras dismunuyen 1.92 gr/ml con respecto a la media

#(c) Escriba la hipótesis que interesa probar con símbolos y con palabras.

Puesto que no hay interacción se desea simplemente verificar si hay un efecto
de la condición sobre la respuesta promedio sin tomar en cuenta el género.
Entonces la hipótesis nula es:
H0 : αi = 0
Esta hipótesis dice que la condición de alimento no tiene efecto sobre la
proteína promedio, es decir, ambas condiciones producen el mismo promedio
de proteína en sangre. Lo anterior sucede en ambos géneros.

#(d) Interprete qué se está midiendo con el cuadrado medio de condición y
#cuadrado medio de género.
```{r}
anova(mod3)
```
variacion entre los niveles de los factores
El cuadrado medio de condición es 38,75 y es una medida de la distancia entre
las medias de las dos condiciones. Similarmente el cuadrado medio de género
es 58,91 y es una medida de la distancia entre las medias de los dos géneros.

#(e) Asegúrese que puede obtener estas cantidades a partir de los efectos
simples.
```{r}
table(base$cond)
table(base$genero)
c(sum(8*alfa^2)/1, sum(8*beta^2)/1)
```


#(f) Observe el cuadrado medio residual y compárelo con la estimación de
la variancia obtenida a partir de la media de las variancias de los 4
tratamientos. ¿Por qué no son iguales?
```{r}
anova(mod3)[3,3]
var_err
```
puesto que el modelo es sin interaccion, los residuales se calculan respecto a la media estimada, sin interaccion
que es distinta de la media obsercada en cada tratamiento, lo cual hace que se note un cambio en la suma de cuadrados residual

#(g) Observe en cuánto aumentó la suma de cuadrados residual en el mod3 con
respecto a la que se obtuvo en el mod2. Explique por qué tiene sentido que el
mod3 tenga una mayor suma de cuadrados residual y por qué la diferencia
debe ser esa cantidad.
```{r}

v1=anova(mod3)[3,2]
v2=anova(mod2)[4,2]
v3=anova(mod2)[3,2]
v4=v1-v2
v=c(v1,v2,v3,v4)
names(v)=c("SC3","SC2","SC2 int","dif SC3-SC2")
v
```
Esto es por la suma de cuadrados de interaccion que se esta ignorando y que ahora se le esta añadiendo a la suma de cuadrados residual

#(h) Observe en la columna de F el valor asociado a la hipótesis y concluya.
```{r}
anova(mod3)
```
H0: ai=0, siendo esta nuestra hipotesis, observando el valor f asociado este nos indica hay suficiente evidencia estadistica para rechar H0
es por esto que no tenemos pruebas para no argumentar diferencia entre los efectos de los distintos tipos de cond con respecto a los niveles de proteina

#(i) Debido a que se concluyó que sí hay diferencia en las medias de proteína
según condición, vale la pena establecer una cota inferior para la magnitud
de esa diferencia.

```{r}
#vectores para obtener las medias marginales de cond-alimento y cond-dieta
c1=c(1,1,0);c2=c(1,-1,0)
#donde queda como 1mu+1alfa+0beta=mu_alimento 1mu-1alfa+0beta=mu_dieta
mod3$coefficients[2] #efecto de dieta(-1.55625) y alimento(1.55625)

c3=c1-c2

(L=t(c3)%*%mod3$coef) #diferencia entre cond alimento y cond dieta, osea la distancia de una a la otra
```

```{r}
gl=anova(mod3)[3,1]
ee=sqrt(t(c3)%*%vcov(mod3)%*%c3)
t=qt(0.95,gl)#13 son los grados de libertad reciduales 
(LIM=L-t*ee)
```
De forma puntual se obtiene en las muestras que el promedio de proteína en
sangre cuando se provee de alimento en abundancia es 3,11 gr/ml mayor que
con dieta. Sin embargo, este resultado está basado solo en una muestras de 16
individuos (8 de cada género). A partir de estos resultados se puede esperar
con 95% de confianza, que con alimento en abundancia el promedio de proteína
en sangre sea al menos 0,77 gr/ml mayor que con dieta. Esto sucede tanto en
machos como en hembras por el hecho de que se asume que no hay interacción
entre condición de alimentación y género.

